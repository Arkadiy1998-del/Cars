CREATE SCHEMA IF NOT EXISTS data_lake;
CREATE SCHEMA IF NOT EXISTS staging;
CREATE SCHEMA IF NOT EXISTS core;

-- создаём таблицы
--BMW
CREATE TABLE IF NOT EXISTS data_lake.BMW_Sales_Data
(
Purchase_date DATE,
Year INT,
Model TEXT,
Revenue FLOAT,
Quantity_Sold INT,
Region TEXT,
Country TEXT,
Channel TEXT
);

--Hyundai
CREATE TABLE IF NOT EXISTS data_lake.Hyundai_raw_data 
(
Car_id FLOAT,
Purchase_Date DATE,
Customer_Name TEXT,
Customer_Gender TEXT,
Customer_Country TEXT,
Agent_Region TEXT,
Customer_Age INT,
Customer_Annual_Income($) INT,
Company TEXT,
Model TEXT,
Engine TEXT,
Transmission TEXT,
Color TEXT,
year_of_model INT,
Price_($) FLOAT
Agent_ID_ INT,
Agent_Name_ INT,
);

--Lada
CREATE TABLE IF NOT EXISTS data_lake.Lada
(
Purchase_Date DATE,
Model TEXT,
Region TEXT,
Price INT,
Engine_Power INT,
Transmission INT,
Fuel_Type TEXT
)

CREATE TABLE IF NOT EXISTS AS staging.bmw_data
(SELECT "Year" AS year, 
DATE_PART('month',"Purchase_Date") AS month,
"Region" AS region,
"Country" AS country,
"Channel" AS channel,
"Model" AS model,
SUM("Revenue") AS month_revenue,
SUM("Quantity_Sold") AS month_qnt
FROM data_lake.bmw_raw_data
WHERE pg_input_is_valid("Purchase_Date", 'date') IS TRUE
GROUP BY 1,2,3,4,5,6
ORDER BY 1,2)

CREATE TABLE IF NOT EXISTS AS staging.hyundai_data
(SELECT DATE_PART('year', DATE("Purchase_Date")) AS year,
DATE_PART('month', DATE("Purchase_Date")) AS month,
"Model" AS model,
SPLIT_PART("Customer_Country", ',', 1) AS country,
SUM("Price_($)") AS revenue,
COUNT(*) AS month_qnt
FROM data_lake.hyundai_raw_data
WHERE pg_input_is_valid("Purchase_Date", 'date') IS TRUE
GROUP BY 1,2,3,4
ORDER BY 1,2)

CREATE TABLE IF NOT EXISTS AS staging.lada_data
(SELECT DATE_PART('year', DATE("Purchase_Date")) AS year,
DATE_PART('month', DATE("Purchase_Date")) AS month,
"Model" AS model,
'Russia' AS country,
FLOOR(SUM("Income") / 75) AS revenue,
COUNT(*) AS month_qnt
FROM data_lake.lada_raw_data
WHERE pg_input_is_valid("Purchase_Date", 'date') IS TRUE
GROUP BY 1,2,3,4
ORDER BY 1,2)
