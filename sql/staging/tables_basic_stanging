CREATE TABLE IF NOT EXISTS staging.bmw_data AS
SELECT "Year"                             :: numeric AS year, 
DATE_PART('month',DATE("Purchase_Date"))  :: numeric AS month,
"Region"                                  :: text AS region,
"Country"                                 :: text AS country,
"Channel"                                 :: text AS channel,
"Model"                                   :: text AS model,
SUM("Revenue")                            :: numeric AS month_revenue,
SUM("Quantity_Sold")                      :: numeric AS month_qnt
FROM data_lake.bmw_raw_data
WHERE "Purchase_Date" IS NOT NULL AND "Year" IN (2021, 2022, 2023) 
GROUP BY 1,2,3,4,5,6
;
CREATE TABLE IF NOT EXISTS staging.hyundai_data AS
SELECT DATE_PART('year', DATE("Purchase_Date")) :: numeric AS year,
DATE_PART('month', DATE("Purchase_Date"))       :: numeric AS month,
"Model"                                         :: text AS model,
SPLIT_PART("Customer_Country", ',', 1)          :: text AS country,
SUM("Price_($)")                                :: numeric AS revenue,
COUNT(*)                                        :: numeric AS month_qnt
FROM data_lake.hyundai_raw_data
WHERE pg_input_is_valid("Purchase_Date", 'date') IS TRUE AND DATE_PART('year', DATE("Purchase_Date")) IN (2021, 2022, 2023)
GROUP BY 1,2,3,4
;
CREATE TABLE IF NOT EXISTS staging.lada_data AS
SELECT DATE_PART('year', DATE("Purchase_Date")) :: numeric AS year,
DATE_PART('month', DATE("Purchase_Date"))       :: numeric AS month,
"Model"                                         :: text AS model,
'Russia'                                        :: text AS country,
FLOOR(SUM("Income") / 75)                       :: numeric AS revenue,
COUNT(*)                                        :: numeric AS month_qnt
FROM data_lake.lada_raw_data
WHERE pg_input_is_valid("Purchase_Date", 'date') IS TRUE
GROUP BY 1,2,3,4
